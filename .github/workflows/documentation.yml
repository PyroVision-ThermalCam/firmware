name: Documentation

on:
  push:
    branches:
      - main
      - master
    paths:
      - docs/**
      - .github/workflows/documentation.yml
  pull_request:
    paths:
      - docs/**
      - .github/workflows/documentation.yml
  workflow_dispatch:

permissions:
  contents: write
  pages: write

jobs:

  asciidoctor:
    runs-on: ubuntu-latest
    name: Documentation (AsciiDoc)

    steps:

    - name: Repository Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Install AsciiDoctor
      run: |
        sudo apt-get update
        sudo apt-get install -y asciidoctor ruby-asciidoctor-pdf

    - name: Build AsciiDoc Documentation
      run: |
        cd docs
        mkdir -p public/pdf
        
        # Find all .adoc files and process them
        echo "Processing AsciiDoc files..."
        for adoc_file in *.adoc; do
          if [ -f "$adoc_file" ]; then
            base_name="${adoc_file%.adoc}"
            echo "  - Building $base_name..."
            
            # Generate HTML
            asciidoctor "$adoc_file" -o "public/${base_name}.html"
            
            # Generate PDF
            asciidoctor-pdf "$adoc_file" -o "public/pdf/${base_name}.pdf"
          fi
        done
        
        # Copy any markdown files as supplementary documentation
        if ls *.md 1> /dev/null 2>&1; then
          cp *.md public/
        fi
        
        # Create index page listing all documentation
        cat > public/index.html << EOF
        <!DOCTYPE html>
        <html lang="en">
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>PyroVision Firmware Documentation</title>
          <style>
            body {
              font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
              max-width: 1200px;
              margin: 0 auto;
              padding: 2rem;
              line-height: 1.6;
              background-color: #f5f5f5;
            }
            h1 {
              color: #333;
              border-bottom: 3px solid #0066cc;
              padding-bottom: 0.5rem;
            }
            h2 {
              color: #555;
              margin-top: 2rem;
            }
            .doc-list {
              background: white;
              padding: 1.5rem;
              border-radius: 8px;
              box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              margin-bottom: 2rem;
            }
            .doc-item {
              padding: 1rem;
              margin: 0.5rem 0;
              background: #f8f9fa;
              border-left: 4px solid #0066cc;
              border-radius: 4px;
            }
            .doc-item h3 {
              margin: 0 0 0.5rem 0;
              color: #0066cc;
            }
            .doc-links {
              margin-top: 0.5rem;
            }
            .doc-links a {
              display: inline-block;
              margin-right: 1rem;
              padding: 0.3rem 0.8rem;
              background: #0066cc;
              color: white;
              text-decoration: none;
              border-radius: 4px;
              font-size: 0.9rem;
            }
            .doc-links a:hover {
              background: #0052a3;
            }
            .footer {
              margin-top: 3rem;
              padding-top: 1rem;
              border-top: 1px solid #ddd;
              color: #666;
              font-size: 0.9rem;
            }
          </style>
        </head>
        <body>
          <h1>ðŸ“š PyroVision Firmware Documentation</h1>
          <p>Complete documentation for the PyroVision ESP32-S3 thermal imaging camera firmware.</p>
          
          <div class="doc-list">
            <h2>ðŸ“– Available Documentation</h2>
        EOF
        
        # Add links for each documentation file
        for html_file in public/*.html; do
          if [ -f "$html_file" ]; then
            html_name=$(basename "$html_file")
            if [ "$html_name" != "index.html" ]; then
              base_name="${html_name%.html}"
              # Create a more readable title
              title=$(echo "$base_name" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
            
              cat >> public/index.html << EOF
            <div class="doc-item">
              <h3>$title</h3>
              <div class="doc-links">
                <a href="$html_name">ðŸ“„ HTML</a>
                <a href="pdf/${base_name}.pdf">ðŸ“• PDF</a>
              </div>
            </div>
        EOF
            fi
          fi
        done
        
        cat >> public/index.html << EOF
          </div>
          
          <div class="footer">
            <p><strong>PyroVision Firmware</strong> - ESP32-S3 Thermal Imaging Camera</p>
            <p>Copyright Â© Daniel Kampert, 2026 | GNU General Public License v3.0</p>
            <p>Generated: \$(date -u +'%Y-%m-%d %H:%M:%S UTC')</p>
          </div>
        </body>
        </html>
        EOF

    - name: Upload Artifact - Documentation
      uses: actions/upload-artifact@v4
      with:
        name: PyroVision-Documentation
        path: docs/public


  deploy:
    if: github.event_name != 'pull_request' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || contains(github.ref, 'refs/tags/'))
    needs:
      - asciidoctor
    runs-on: ubuntu-latest
    name: Deploy to Releases and Pages

    steps:

    - name: Repository Checkout
      uses: actions/checkout@v4

    - name: Download Artifacts
      uses: actions/download-artifact@v4

    - name: Organize public subdir and create a tarball
      run: |
        mv PyroVision-Documentation public
        mv public/pdf ./
        tar zvcf PyroVision-Docs-nightly.tar.gz -C public .
        # Rename all PDFs with nightly suffix
        cd pdf
        for pdf_file in *.pdf; do
          if [ -f "$pdf_file" ]; then
            base_name="${pdf_file%.pdf}"
            mv "$pdf_file" "${base_name}-nightly.pdf"
          fi
        done

    # Tagged: create a pre-release or a release (semver)
    # Untagged: update the assets of pre-release nightly
    - name: Deploy to GitHub-Releases
      env:
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        # Create nightly release if it doesnt exist
        gh release view nightly 2>/dev/null || gh release create nightly --title "Nightly Build" --notes "Automatically generated documentation" --prerelease
        # Upload tarball and all PDFs
        gh release upload nightly PyroVision-Docs-nightly.tar.gz pdf/*.pdf --clobber

    - name: Deploy to GitHub-Pages
      run: |
        cd public
        git init
        # use authenticated remote (GITHUB_TOKEN is available as a secret)
        git remote add origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
        touch .nojekyll
        git add .
        git config --local user.email "push@gha"
        git config --local user.name "GHA"
        git commit -am "update documentation ${{ github.sha }}"
        git push -u origin +HEAD:gh-pages --force
